<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --sidebar-bg: #1E2923;
            --main-bg: #F4F5F4;
            --accent: #587363;
            --text-dark: #1F2937;
            --text-muted: #6B7280;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { display: flex; height: 100vh; background: var(--main-bg); overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background: var(--sidebar-bg); color: var(--white); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; gap: 20px; }
        .brand { font-size: 1.3rem; font-weight: 800; color: #A3B18A; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .user-widget { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .avatar { width: 34px; height: 34px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
        
        .nav-section { display: flex; flex-direction: column; gap: 4px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #6B7280; margin-bottom: 4px; font-weight: 700; }
        .nav-item { padding: 10px 14px; border-radius: 8px; color: #D1D5DB; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; transition: 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--accent); color: white; font-weight: 600; }

        .action-section { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
        .btn-action { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 0.85rem; transition: transform 0.2s; }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-found { background: #A3B18A; color: #1E2923; } 
        .btn-lost { background: #FCA5A5; color: #7F1D1D; }   
        .logout { margin-top: 5px; color: #ef4444; cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px; opacity: 0.8; font-size: 0.9rem; font-weight: 600; }

        /* --- MAIN AREA --- */
        .main-content { flex: 1; display: flex; flex-direction: column; }
        
        /* NEW STYLE FOR DEV NOTICE */
        .dev-notice {
            background: #FEF3C7; /* Soft Yellow/Amber */
            color: #92400E;      /* Dark Amber Text */
            padding: 8px 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-bottom: 1px solid #FCD34D;
            text-align: center;
        }

        .header { padding: 20px 30px; background: var(--main-bg); display: flex; flex-direction: column; gap: 15px; }
        .page-title { font-size: 1.6rem; font-weight: 800; color: var(--text-dark); }
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .cat-pill { background: var(--white); border: 1px solid #E5E7EB; padding: 6px 16px; border-radius: 30px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.2s; }
        .cat-pill:hover, .cat-pill.active { background: var(--sidebar-bg); color: var(--white); border-color: var(--sidebar-bg); }

        .grid-container { flex: 1; overflow-y: auto; padding: 0 30px 30px 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }

        /* --- CARD STYLING --- */
        .card { 
            display: flex;
            flex-direction: column;
            background: var(--white); 
            border-radius: 14px; 
            overflow: hidden; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            transition: all 0.2s ease; 
            height: 380px; 
            border: 1px solid #F3F4F6;
            position: relative;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* --- IMAGE CONTAINER --- */
        .card-img-wrapper {
            height: 180px;      /* Fixed Height */
            min-height: 180px;  /* Force Strict Height */
            max-height: 180px;
            width: 100%;
            background: #E5E7EB;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        /* 3x2 Grid Logic */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, minmax(0, 1fr)); 
            height: 100%;
            width: 100%;
            gap: 1px;
        }

        .single-layout { width: 100%; height: 100%; display: flex; }

        /* Forces image to squeeze into the grid cell */
        .card-img {
            width: 100%; height: 100%;
            object-fit: cover; 
            display: block;
        }

        .no-image {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: #F3F4F6; color: #9CA3AF;
        }
        .no-image i { font-size: 1.5rem; margin-bottom: 5px; opacity: 0.5; }
        .no-image span { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #6B7280; }

        .badge { 
            position: absolute; top: 8px; right: 8px; 
            padding: 4px 10px; border-radius: 20px; 
            font-size: 0.6rem; font-weight: 800; text-transform: uppercase; 
            z-index: 10; letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .badge-Found { background: rgba(255, 255, 255, 0.95); color: #15803D; }
        .badge-Request { background: rgba(255, 255, 255, 0.95); color: #B91C1C; }

        /* --- TEXT CONTAINER --- */
        .card-body { 
            flex: 1; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            background: white;
            overflow: hidden;
        }
        
        .c-cat { font-size: 0.65rem; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }
        .c-title { 
            font-weight: 800; font-size: 1rem; color: var(--text-dark); 
            margin-bottom: 6px; line-height: 1.2; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .c-desc { 
            font-size: 0.85rem; color: #6B7280; 
            line-height: 1.4; 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; 
            margin-bottom: auto;
        }
        .c-meta { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.7rem; color: #9CA3AF; 
            padding-top: 10px; border-top: 1px solid #F3F4F6; font-weight: 600;
            margin-top: 10px;
        }
        .c-meta i { margin-right: 4px; color: #D1D5DB; }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fa-solid fa-compass"></i> True Claim</div>
        
        <div class="user-widget">
            <div class="avatar">{{ user_name[0] if user_name else 'U' }}</div>
            <div style="overflow:hidden;">
                <div style="font-size:0.85rem; font-weight:600;">{{ user_name if user_name else 'Guest' }}</div>
                <div style="font-size:0.7rem; opacity:0.7; overflow:hidden; text-overflow:ellipsis;">{{ user_email }}</div>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-label">Browse</div>
            <div class="nav-item active" onclick="setFilter('type', 'all', this)">
                <i class="fa-solid fa-layer-group"></i> All Posts
            </div>
            <div class="nav-item" onclick="setFilter('type', 'Found', this)">
                <i class="fa-solid fa-box-open"></i> Found Items
            </div>
            <div class="nav-item" onclick="setFilter('type', 'Request', this)">
                <i class="fa-solid fa-hand-holding-heart"></i> Lost Requests
            </div>
            <div class="nav-item" onclick="window.location.href='/about'">
                <i class="fa-solid fa-circle-info"></i> About
            </div>
        </div>

        <div class="action-section">
             <div class="nav-label">Actions</div>
             <a href="/create-found" class="btn-action btn-found">
                <i class="fa-solid fa-plus-circle"></i> I Found Item
             </a>
             <a href="/create-lost" class="btn-action btn-lost">
                <i class="fa-solid fa-circle-exclamation"></i> I Lost Item
             </a>
             <div class="logout" onclick="window.location.href='/logout'">
                <i class="fa-solid fa-power-off"></i> Log Out
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="dev-notice">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span><strong>Development Mode:</strong> This site works best on Desktops/Laptops. Mobile view is currently under construction.</span>
        </div>

        <div class="header">
            <h1 class="page-title">Dashboard</h1>
            
            <div class="cat-scroll">
                <div class="cat-pill active" onclick="setFilter('cat', 'all', this)">All</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Electronics', this)">Electronics</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Documents', this)">Documents</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Wallets', this)">Wallets</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Keys', this)">Keys</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Stationary', this)">Stationary</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Clothing', this)">Clothing</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Valuables', this)">Valuables</div>
                <div class="cat-pill" onclick="setFilter('cat', 'Others', this)">Others</div>
            </div>
        </div>

        <div class="grid-container">
            <div id="grid" class="grid"></div>
        </div>
    </main>

    <script>
        const CURRENT_USER_ID = "{{ user_id }}";
        const FOUND_API = "{{ url_for('static', filename='posts.json') }}";
        const LOST_API = "{{ url_for('static', filename='requests.json') }}";
        
        let foundItems = [];
        let lostItems = [];
        let filter = { type: 'all', cat: 'all' };

        async function loadAll() {
            try {
                const [foundRes, lostRes] = await Promise.all([
                    fetch(FOUND_API),
                    fetch(LOST_API)
                ]);

                const parseData = async (res, forceType) => {
                    if (!res.ok) return [];
                    const raw = await res.json();
                    let allPosts = [];
                    if (Array.isArray(raw)) {
                        raw.forEach(group => {
                            Object.entries(group).forEach(([key, val]) => {
                                val.id = key;
                                val.type = forceType;
                                allPosts.push(val);
                            });
                        });
                    }
                    return allPosts;
                };

                foundItems = await parseData(foundRes, 'Found');
                lostItems = await parseData(lostRes, 'Request');
                render();
            } catch (e) { console.error("Error loading data:", e); }
        }

        function setFilter(key, val, el) {
            filter[key] = val;
            if(key === 'type') {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            } else {
                document.querySelectorAll('.cat-pill').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            render();
        }

        function render() {
            const container = document.getElementById('grid');
            container.innerHTML = '';

            let sourceData = [];
            if (filter.type === 'all') sourceData = [...foundItems, ...lostItems];
            else if (filter.type === 'Found') sourceData = foundItems;
            else if (filter.type === 'Request') sourceData = lostItems;

            // --- SORTING LOGIC: NEWEST FIRST ---
            // This reads the 'time' or 'date' field, converts it to a Date object,
            // and sorts descending (B - A).
            sourceData.sort((a, b) => {
                const dateA = new Date(a.time || a.date || 0); // Handle missing dates safely
                const dateB = new Date(b.time || b.date || 0);
                return dateB - dateA; 
            });
            // -----------------------------------

            const visible = sourceData.filter(p => {
                const catOk = filter.cat === 'all' || 
                             (p.category && p.category.toLowerCase() === filter.cat.toLowerCase());
                return catOk;
            });

            if(visible.length === 0) {
                container.innerHTML = '<div id="loading">No items found.</div>';
                return;
            }

            visible.forEach(p => {
                const timestamp = new Date().getTime(); 
                const mainExt = p.ext ? p.ext : 'jpg'; 
                
                let imageSection = '';
                
                if (p.type === 'Found') {
                    // FOUND: 3x2 Grid
                    let imageIndices = [1, 2, 3, 4, 5, 6];
                    for (let i = imageIndices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [imageIndices[i], imageIndices[j]] = [imageIndices[j], imageIndices[i]];
                    }

                    let imgs = '';
                    imageIndices.forEach(i => {
                        let currentExt = (i === 1) ? mainExt : 'jpg';
                        imgs += `<img src="/static/posts/${p.id}/${i}.${currentExt}?t=${timestamp}" 
                                      class="card-img" 
                                      onerror="if(this.src.endsWith('jpg?t=${timestamp}')) this.src='/static/posts/${p.id}/${i}.jpeg?t=${timestamp}'; else this.src='https://placehold.co/100x100/EEE/EEE?text=Loading';">`;
                    });
                    
                    imageSection = `<div class="card-img-wrapper grid-layout">${imgs}</div>`;
                
                } else {
                    // LOST: Single Image
                    if (p.ext && p.ext !== "" && p.ext !== "null") {
                        imageSection = `
                            <div class="card-img-wrapper single-layout">
                                <img src="/static/requests/${p.id}/1.${mainExt}?t=${timestamp}" 
                                     class="card-img" 
                                     onerror="this.parentElement.innerHTML='<div class=\'no-image\'><i class=\'fa-solid fa-image-slash\'></i><span>Image Not Available</span></div>'">
                            </div>`;
                    } else {
                        imageSection = `
                            <div class="card-img-wrapper single-layout">
                                <div class="no-image">
                                    <i class="fa-solid fa-eye-slash"></i>
                                    <span>No Reference Image Available</span>
                                </div>
                            </div>`;
                    }
                }

                const authorId = p.user_id || p.UID;
                const isOwner = (authorId === CURRENT_USER_ID);
                let link = '#';
                let clickAction = '';

                if (isOwner) {
                    link = 'javascript:void(0)';
                    clickAction = `onclick="alert('Edit your post feature is in progress.')"`;
                } else {
                    if (p.id) {
                        link = (p.type === 'Found' ? `/found-details?id=${p.id}` : `/lost-details?id=${p.id}`);
                    }
                }

                const html = `
                    <a href="${link}" ${clickAction} class="card" style="text-decoration:none; color:inherit;">
                        ${imageSection}
                        <div class="badge badge-${p.type}">${p.type === 'Request' ? 'LOST' : 'FOUND'}</div>
                        <div class="card-body">
                            <div>
                                <div class="c-cat">${p.category}</div>
                                <div class="c-title">${p.title}</div>
                                <div class="c-desc">${p.description || "No description provided."}</div>
                            </div>
                            <div class="c-meta">
                                <span><i class="fa-solid fa-location-dot"></i> ${p.location}</span>
                                <span>${p.time || p.date}</span>
                            </div>
                        </div>
                    </a>
                `;
                container.innerHTML += html;
            });
        }

        loadAll();
    </script>
</body>
</html>